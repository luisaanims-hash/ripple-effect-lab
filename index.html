<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ripple Effect Lab</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(to bottom, #1a3a5f, #2c5f8a);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            width: 100%;
            padding: 0 10px;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            line-height: 1.2;
        }

        .subtitle {
            font-size: 1.1rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            height: 85vh;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 20px;
        }

        .active {
            display: flex;
        }

        /* Introduction Screen Styles */
        #introduction-screen {
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .intro-content {
            max-width: 800px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .intro-content h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #4da8da;
        }

        .intro-content p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 15px;
            text-align: left;
        }

        .intro-content ul {
            text-align: left;
            margin: 20px 0;
            padding-left: 20px;
        }

        .intro-content li {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .highlight {
            color: #4da8da;
            font-weight: bold;
        }

        .start-lab-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .start-lab-btn:hover {
            background: #219653;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Start Screen Styles */
        #start-screen {
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .scenario-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            width: 100%;
            margin-top: 30px;
        }

        .scenario-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .scenario-card:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-5px);
            border-color: #4da8da;
        }

        .scenario-card h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .scenario-card p {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        /* Pond Screen Styles - FIXED LAYOUT */
        #pond-screen {
            flex-direction: column;
        }

        .pond-area {
            display: flex;
            flex: 1;
            gap: 20px;
            margin-bottom: 15px;
            min-height: 0;
        }

        .pebbles-panel {
            width: 280px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .pebbles-panel h2 {
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.4rem;
        }

        .pebble-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pebble-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .pebble-item.active {
            background: rgba(77, 168, 218, 0.4);
            border-left: 4px solid #4da8da;
        }

        .pond-container {
            flex: 1;
            position: relative;
            background: linear-gradient(to bottom, #1e5799, #207cca);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .pond {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.7);
            transform: translate(-50%, -50%);
            pointer-events: none;
            opacity: 0;
        }

        .ripple-text {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            max-width: 280px;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-left: 4px solid #4da8da;
        }

        .ripple-text.active {
            opacity: 1;
        }

        /* Controls - FIXED POSITION */
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 0;
            padding: 10px;
            flex-shrink: 0;
        }

        button {
            background: #4da8da;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            min-width: 120px;
        }

        button:hover {
            background: #3d8fc7;
            transform: translateY(-2px);
        }

        .reset-btn {
            background: #e74c3c;
        }

        .reset-btn:hover {
            background: #c0392b;
        }

        .exit-ticket-btn {
            background: #27ae60;
        }

        .exit-ticket-btn:hover {
            background: #219653;
        }

        /* Instructions */
        .instructions {
            margin-top: 8px;
            font-size: 0.8rem;
            opacity: 0.8;
            text-align: center;
            flex-shrink: 0;
        }

        /* Exit Ticket Screen Styles */
        #exit-ticket-screen {
            align-items: center;
            justify-content: flex-start;
        }

        .exit-ticket-container {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 30px;
            width: 100%;
            max-width: 800px;
            margin-top: 20px;
        }

        .exit-ticket-container h2 {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-group textarea {
            min-height: 200px;
            resize: vertical;
        }

        .exit-ticket-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            gap: 10px;
        }

        .submit-btn {
            background: #9b59b6;
        }

        .submit-btn:hover {
            background: #8e44ad;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .pond-area {
                flex-direction: column;
            }
            
            .pebbles-panel {
                width: 100%;
                max-height: 200px;
            }
            
            .pond-container {
                min-height: 300px;
            }

            .controls {
                flex-wrap: wrap;
            }

            button {
                min-width: 100px;
                font-size: 0.8rem;
                padding: 6px 12px;
            }

            .ripple-text {
                max-width: 200px;
                font-size: 0.8rem;
            }

            h1 {
                font-size: 1.8rem;
            }

            .subtitle {
                font-size: 1rem;
            }
        }

        /* Print Styles */
        @media print {
            body, .container {
                background: white !important;
                color: black !important;
                box-shadow: none !important;
                height: auto !important;
                min-height: auto !important;
            }

            header, .controls, .pebbles-panel, .pond-container, 
            #start-screen, #pond-screen, #introduction-screen, .instructions, 
            .exit-ticket-btn, .back-btn, .reset-btn {
                display: none !important;
            }

            #exit-ticket-screen {
                display: flex !important;
                height: auto !important;
                padding: 0 !important;
            }

            .exit-ticket-container {
                background: white !important;
                color: black !important;
                padding: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
                box-shadow: none !important;
            }

            .form-group input, .form-group textarea {
                background: white !important;
                color: black !important;
                border: 1px solid black !important;
            }

            .print-btn, .submit-btn {
                display: none !important;
            }
        }
    </style>
    <!-- Add jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <header>
        <h1>The Ripple Effect Lab</h1>
        <p class="subtitle">An Interactive Cause & Consequence Simulator</p>
    </header>

    <div class="container">
        <!-- Introduction Screen -->
        <div id="introduction-screen" class="screen active">
            <div class="intro-content">
                <h2>Welcome to The Ripple Effect Lab!</h2>
                <p>History isn't just a collection of dates and events—it's a complex web of <span class="highlight">causes and consequences</span> that ripple through time. In this interactive lab, you'll explore how single actions can create waves of change that transform societies, economies, and environments.</p>
                
                <p><span class="highlight">How does it work?</span></p>
                <ul>
                    <li><strong>Choose a historical scenario</strong> from periods like the Gilded Age, Great Depression, or modern challenges</li>
                    <li><strong>Drop "pebbles" (causes)</strong> into our virtual pond and watch the ripples unfold</li>
                    <li><strong>Follow the chain of consequences</strong> from immediate effects to long-term impacts</li>
                    <li><strong>Discover patterns</strong> that repeat across different historical periods</li>
                </ul>
                
                <p>By the end of this lab, you'll understand how solving one problem often creates new challenges—and how we can learn from history to make better decisions today.</p>
                
                <p><span class="highlight">Ready to see how your actions today might ripple into tomorrow?</span></p>
                
                <button class="start-lab-btn" id="start-lab-btn">Start Exploring History's Ripples</button>
            </div>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="screen">
            <h2>Select a Historical Scenario</h2>
            <div class="scenario-list" id="scenario-list">
                <!-- Scenarios will be populated by JavaScript -->
            </div>
        </div>

        <!-- Pond Screen - FIXED LAYOUT -->
        <div id="pond-screen" class="screen">
            <div class="pond-area">
                <div class="pebbles-panel">
                    <h2 id="scenario-title">Scenario Title</h2>
                    <div id="pebbles-list">
                        <!-- Pebbles will be populated by JavaScript -->
                    </div>
                </div>
                <div class="pond-container">
                    <div class="pond" id="pond">
                        <!-- Ripples and text will be added here by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- BUTTONS NOW BELOW THE POND -->
            <div class="controls">
                <button id="back-btn">Back to Scenarios</button>
                <button id="exit-ticket-btn" class="exit-ticket-btn">Exit Ticket</button>
                <button id="reset-btn" class="reset-btn">Reset Ripples</button>
            </div>
            <p class="instructions">Click on a cause to see its consequences ripple through history. Each ripple shows the timeline of interconnected events.</p>
        </div>

        <!-- Exit Ticket Screen -->
        <div id="exit-ticket-screen" class="screen">
            <div class="exit-ticket-container">
                <h2>Exit Ticket</h2>
                <div class="form-group">
                    <label for="student-name">Name:</label>
                    <input type="text" id="student-name" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label for="student-id">Student ID (optional):</label>
                    <input type="text" id="student-id" placeholder="Enter student ID">
                </div>
                <div class="form-group">
                    <label for="key-question">Key Question:</label>
                    <p id="key-question">
                        "Select one historical scenario (like the Dust Bowl or Grand Coulee Dam) and one modern scenario (like Industrial Agriculture or the 'Green' Transition).
                        <br><br>
                        Based on what you saw in the lab, what is the single most important repeating pattern or lesson you see about the relationship between solving one problem (like needing food or energy) and creating new, unintended problems for people or the environment?"
                    </p>
                </div>
                <div class="form-group">
                    <label for="student-answer">Your Answer:</label>
                    <textarea id="student-answer" placeholder="Type your response here..."></textarea>
                </div>
                <div class="exit-ticket-controls">
                    <button id="back-from-exit-btn">Back to Lab</button>
                    <button id="submit-btn" class="submit-btn">Submit & Download PDF</button>
                    <button id="print-btn" class="print-btn">Print Only</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Content with More Scenarios and Modern Parallels
        const content = {
            scenarios: [
                {
                    id: "gilded-age",
                    title: "The Gilded Age",
                    description: "Explore the environmental and social consequences of industrialization",
                    pebbles: [
                        {
                            title: "Unchecked Logging in Wisconsin (1860s-1870s)",
                            ripples: [
                                "Millions of acres of forest are clear-cut for lumber, leaving dry 'slash' (wood debris) that becomes highly flammable",
                                "Boom towns like Peshtigo are built entirely from wood to support the lumber industry, creating dense communities in fire-prone areas",
                                "The Great Peshtigo Fire: A perfect storm of drought, high winds, and dry slash creates the deadliest fire in US history, killing 1,500-2,500 people and destroying entire ecosystems"
                            ]
                        },
                        {
                            title: "Railroad Expansion & Land Grants (1860s-1890s)",
                            ripples: [
                                "Federal government grants 170 million acres to railroad companies to encourage transcontinental expansion",
                                "Railroads create massive fortunes for industrialists while displacing Native American tribes from their ancestral lands",
                                "Railroad monopolies lead to price discrimination against farmers, sparking the Populist movement and demands for regulation",
                                "Wealth concentration in railroad magnates contributes to extreme income inequality that characterizes the Gilded Age"
                            ]
                        },
                        {
                            title: "Modern Parallel: California Wildfires (2010s-2020s)",
                            ripples: [
                                "Population growth pushes development into wildfire-prone areas while climate change creates drier conditions",
                                "PG&E power lines spark the Camp Fire, destroying Paradise, CA and killing 85 people - similar infrastructure risks as Peshtigo",
                                "Record-breaking fire season burns 4.3 million acres in California, forcing mass evacuations and creating air quality crises",
                                "Utility companies face bankruptcy from liability, while insurance becomes unaffordable in high-risk areas, creating new economic challenges"
                            ]
                        }
                    ]
                },
                {
                    id: "great-depression",
                    title: "The Great Depression & Dust Bowl",
                    description: "Understand the interconnected causes of economic and environmental disaster",
                    pebbles: [
                        {
                            title: "Decades of Prairie Grass Destruction (1900-1930)",
                            ripples: [
                                "Native prairie grasses that anchored the soil for centuries are plowed under for wheat farming across the Great Plains",
                                "Severe drought hits the region. Without grass roots to hold it, topsoil turns to dust and creates massive 'black blizzards'",
                                "Dust Bowl conditions force 2.5 million people to abandon their farms. Many become 'Okies' migrating to California for work",
                                "Refugee camps called 'Hoovervilles' spring up nationwide, creating extreme poverty and social conflict that lasts for years"
                            ]
                        },
                        {
                            title: "Unregulated Bank Failures (1929-1933)",
                            ripples: [
                                "9,000 banks fail nationwide. Families lose their entire life savings with no deposit insurance",
                                "Consumer spending drops 50%. People stop buying cars, appliances, and other goods out of fear and necessity",
                                "Factories mass-close due to lack of customers. Unemployment reaches 25% - 15 million Americans lose their jobs",
                                "Mass evictions create homeless populations. Breadlines form as poverty becomes widespread and visible"
                            ]
                        },
                        {
                            title: "Modern Parallel: 2008 Financial Crisis",
                            ripples: [
                                "Deregulation and complex financial instruments create a housing bubble similar to 1920s stock speculation",
                                "Lehman Brothers collapse triggers global financial crisis, reminiscent of 1929 bank failures",
                                "Mass foreclosures and 8.7 million job losses create modern 'Hoovervilles' and economic desperation",
                                "Government bailouts and quantitative easing save system but create wealth inequality and political backlash like New Deal era"
                            ]
                        }
                    ]
                },
                {
                    id: "new-deal-rural",
                    title: "The New Deal - Rural Electrification",
                    description: "Trace the impacts of bringing electricity to rural America",
                    pebbles: [
                        {
                            title: "Rural Electrification Act of 1936",
                            ripples: [
                                "REA provides low-cost loans to rural cooperatives to build electric grids where private companies won't invest",
                                "Rural electrification jumps from 10% to 90%. Farm families get electric lights, refrigeration, and radios for the first time",
                                "Demand for electric appliances creates new industries and jobs. Rural quality of life improves dramatically",
                                "Massive new power sources are built, primarily hydroelectric dams and coal plants, creating new environmental impacts"
                            ]
                        },
                        {
                            title: "Modern Parallel: Digital Divide & AI Revolution",
                            ripples: [
                                "Internet access becomes essential, creating a 'digital divide' between connected urban and disconnected rural areas",
                                "Tech companies like Google dominate information access, similar to how electric companies initially served only profitable areas",
                                "AI tools become essential for education and work, creating new inequalities in access and skills",
                                "Like REA, government initiatives attempt to provide broadband access, but face challenges of cost, infrastructure, and corporate resistance"
                            ]
                        }
                    ]
                },
                {
                    id: "new-deal-dams",
                    title: "The New Deal - Big Dam Projects",
                    description: "Examine the complex legacy of large-scale infrastructure projects",
                    pebbles: [
                        {
                            title: "Grand Coulee Dam Construction (1933-1942)",
                            ripples: [
                                "Thousands of unemployed workers get jobs through New Deal programs, providing crucial economic relief",
                                "Dam completion permanently blocks salmon migration, devastating a food source that sustained communities for millennia",
                                "Ancestral fishing grounds of Indigenous tribes like the Colville are flooded, violating treaties and destroying cultural sites",
                                "Dam provides cheap electricity for WWII industries and irrigation for desert farming, but fundamentally alters the Columbia River ecosystem forever"
                            ]
                        },
                        {
                            title: "Modern Parallel: Renewable Energy Infrastructure",
                            ripples: [
                                "Large-scale solar and wind farms provide clean energy but require massive land use, displacing wildlife and local communities",
                                "Battery production for energy storage creates demand for rare earth minerals with environmental and human rights concerns",
                                "Transmission lines for renewable energy face similar NIMBY ('Not In My Backyard') opposition as historical infrastructure projects",
                                "Like dams, modern green infrastructure creates tension between environmental benefits and local ecological/social impacts"
                            ]
                        }
                    ]
                },
                {
                    id: "modern-agriculture",
                    title: "Modern - Industrial Agriculture",
                    description: "Follow the chain of consequences from modern farming practices",
                    pebbles: [
                        {
                            title: "Industrial Monoculture Farming (1970s-Present)",
                            ripples: [
                                "Farm subsidies encourage fence-row to fence-row planting of corn/soybeans, relying heavily on chemical inputs",
                                "Soil remains bare for much of the year without diverse root systems to anchor it, leading to erosion",
                                "Topsoil erodes at alarming rates while chemical runoff creates massive 'Dead Zones' in the Gulf of Mexico",
                                "While yields are high, soil degradation threatens long-term food security and requires ever-more expensive chemical inputs"
                            ]
                        }
                    ]
                },
                {
                    id: "green-transition",
                    title: "Modern - The 'Green' Transition",
                    description: "Explore the unintended consequences of transitioning to renewable energy",
                    pebbles: [
                        {
                            title: "Critical Minerals Rush (2010s-Present)",
                            ripples: [
                                "Global push for EVs and batteries creates massive demand for lithium, cobalt, and copper",
                                "New mines open in sensitive areas like Thacker Pass (NV) and developing nations (Congo, Bolivia), often on Indigenous lands",
                                "Large-scale mining consumes vast water resources in arid regions and risks polluting local ecosystems",
                                "The solution to climate crisis (caused by 20th-century extraction) creates new 21st-century extraction challenges, repeating historical patterns of environmental justice issues"
                            ]
                        }
                    ]
                }
            ]
        };

        // Database simulation using localStorage
        const ResponseDB = {
            init() {
                if (!localStorage.getItem('rippleLabResponses')) {
                    localStorage.setItem('rippleLabResponses', JSON.stringify([]));
                }
            },

            saveResponse(response) {
                const responses = JSON.parse(localStorage.getItem('rippleLabResponses'));
                responses.push({
                    ...response,
                    timestamp: new Date().toISOString(),
                    id: Date.now() + Math.random()
                });
                localStorage.setItem('rippleLabResponses', JSON.stringify(responses));
                return true;
            },

            getResponses() {
                return JSON.parse(localStorage.getItem('rippleLabResponses') || '[]');
            },

            exportData() {
                const responses = this.getResponses();
                const csv = this.convertToCSV(responses);
                this.downloadCSV(csv, 'ripple-lab-responses.csv');
            },

            convertToCSV(data) {
                if (data.length === 0) return '';
                const headers = Object.keys(data[0]);
                const csv = [
                    headers.join(','),
                    ...data.map(row => headers.map(header => {
                        const value = row[header] || '';
                        return `"${value.toString().replace(/"/g, '""')}"`;
                    }).join(','))
                ];
                return csv.join('\n');
            },

            downloadCSV(csv, filename) {
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);
            }
        };

        // DOM Elements
        const introductionScreen = document.getElementById('introduction-screen');
        const startScreen = document.getElementById('start-screen');
        const pondScreen = document.getElementById('pond-screen');
        const exitTicketScreen = document.getElementById('exit-ticket-screen');
        const startLabBtn = document.getElementById('start-lab-btn');
        const scenarioList = document.getElementById('scenario-list');
        const scenarioTitle = document.getElementById('scenario-title');
        const pebblesList = document.getElementById('pebbles-list');
        const pond = document.getElementById('pond');
        const backBtn = document.getElementById('back-btn');
        const exitTicketBtn = document.getElementById('exit-ticket-btn');
        const resetBtn = document.getElementById('reset-btn');
        const backFromExitBtn = document.getElementById('back-from-exit-btn');
        const printBtn = document.getElementById('print-btn');
        const submitBtn = document.getElementById('submit-btn');

        // Current state
        let currentScenario = null;
        let activePebble = null;
        let activeRipples = [];

        // Initialize the application
        function init() {
            ResponseDB.init();
            renderScenarios();
            setupEventListeners();
        }

        // Render scenario cards on the start screen
        function renderScenarios() {
            scenarioList.innerHTML = '';
            
            content.scenarios.forEach(scenario => {
                const scenarioCard = document.createElement('div');
                scenarioCard.className = 'scenario-card';
                scenarioCard.dataset.id = scenario.id;
                
                scenarioCard.innerHTML = `
                    <h3>${scenario.title}</h3>
                    <p>${scenario.description}</p>
                `;
                
                scenarioList.appendChild(scenarioCard);
            });
        }

        // Set up event listeners
        function setupEventListeners() {
            // Scenario selection
            scenarioList.addEventListener('click', e => {
                const scenarioCard = e.target.closest('.scenario-card');
                if (scenarioCard) {
                    const scenarioId = scenarioCard.dataset.id;
                    selectScenario(scenarioId);
                }
            });
            
            // Pebble selection
            pebblesList.addEventListener('click', e => {
                const pebbleItem = e.target.closest('.pebble-item');
                if (pebbleItem) {
                    const pebbleIndex = parseInt(pebbleItem.dataset.index);
                    selectPebble(pebbleIndex);
                }
            });
            
            // Navigation buttons
            backBtn.addEventListener('click', goBackToScenarios);
            exitTicketBtn.addEventListener('click', showExitTicket);
            resetBtn.addEventListener('click', resetRipples);
            backFromExitBtn.addEventListener('click', goBackToPond);
            printBtn.addEventListener('click', printExitTicket);
            submitBtn.addEventListener('click', submitExitTicket);
            startLabBtn.addEventListener('click', () => {
                introductionScreen.classList.remove('active');
                startScreen.classList.add('active');
            });

            // Teacher access to database (hidden feature - press Ctrl+D)
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    ResponseDB.exportData();
                    alert('All student responses exported as CSV file!');
                }
            });
        }

        // Select a scenario and show the pond screen
        function selectScenario(scenarioId) {
            currentScenario = content.scenarios.find(s => s.id === scenarioId);
            if (!currentScenario) return;
            
            // Update UI
            scenarioTitle.textContent = currentScenario.title;
            renderPebbles();
            
            // Switch screens
            startScreen.classList.remove('active');
            pondScreen.classList.add('active');
            
            // Reset any active ripples
            resetRipples();
        }

        // Render pebbles for the current scenario
        function renderPebbles() {
            pebblesList.innerHTML = '';
            
            currentScenario.pebbles.forEach((pebble, index) => {
                const pebbleItem = document.createElement('div');
                pebbleItem.className = 'pebble-item';
                pebbleItem.dataset.index = index;
                pebbleItem.textContent = pebble.title;
                
                pebblesList.appendChild(pebbleItem);
            });
        }

        // Select a pebble and show its ripple effects
        function selectPebble(pebbleIndex) {
            // Clear previous ripples
            resetRipples();
            
            // Update active pebble
            const pebbleItems = document.querySelectorAll('.pebble-item');
            pebbleItems.forEach(item => item.classList.remove('active'));
            pebbleItems[pebbleIndex].classList.add('active');
            
            activePebble = currentScenario.pebbles[pebbleIndex];
            
            // Create ripples
            createRipples(activePebble.ripples);
        }

        // Create ripple animations and text
        function createRipples(rippleTexts) {
            const centerX = pond.offsetWidth / 2;
            const centerY = pond.offsetHeight / 2;
            
            rippleTexts.forEach((text, index) => {
                // Create ripple element
                const ripple = document.createElement('div');
                ripple.className = 'ripple';
                
                // Size increases with each ripple
                const size = 100 + (index * 100);
                ripple.style.width = `${size}px`;
                ripple.style.height = `${size}px`;
                ripple.style.left = `${centerX}px`;
                ripple.style.top = `${centerY}px`;
                
                // Create text element
                const textElement = document.createElement('div');
                textElement.className = 'ripple-text';
                textElement.textContent = text;
                
                // Position text around the pond
                const angle = (index * 90) % 360;
                const radius = 150 + (index * 50);
                const textX = centerX + radius * Math.cos(angle * Math.PI / 180);
                const textY = centerY + radius * Math.sin(angle * Math.PI / 180);
                
                textElement.style.left = `${textX}px`;
                textElement.style.top = `${textY}px`;
                
                // Add to pond
                pond.appendChild(ripple);
                pond.appendChild(textElement);
                
                // Store references
                activeRipples.push({ripple, text: textElement});
                
                // Animate with delay
                setTimeout(() => {
                    ripple.style.transition = 'all 2s ease-out';
                    ripple.style.opacity = '1';
                    ripple.style.transform = `translate(-50%, -50%) scale(1.5)`;
                    
                    textElement.classList.add('active');
                }, index * 800);
                
                // Fade out ripple after animation
                setTimeout(() => {
                    ripple.style.opacity = '0';
                }, (index * 800) + 2000);
            });
        }

        // Reset all ripples
        function resetRipples() {
            activeRipples.forEach(({ripple, text}) => {
                if (ripple.parentNode) ripple.parentNode.removeChild(ripple);
                if (text.parentNode) text.parentNode.removeChild(text);
            });
            
            activeRipples = [];
            
            // Clear active pebble
            const activePebbleItem = document.querySelector('.pebble-item.active');
            if (activePebbleItem) {
                activePebbleItem.classList.remove('active');
            }
            
            activePebble = null;
        }

        // Go back to the scenario selection screen
        function goBackToScenarios() {
            pondScreen.classList.remove('active');
            startScreen.classList.add('active');
            resetRipples();
            currentScenario = null;
        }

        // Show the exit ticket screen
        function showExitTicket() {
            pondScreen.classList.remove('active');
            exitTicketScreen.classList.add('active');
        }

        // Go back to the pond screen from exit ticket
        function goBackToPond() {
            exitTicketScreen.classList.remove('active');
            pondScreen.classList.add('active');
        }

        // Print the exit ticket as PDF
        function printExitTicket() {
            window.print();
        }

        // Enhanced Exit Ticket Submission
        async function submitExitTicket() {
            const studentName = document.getElementById('student-name').value;
            const studentId = document.getElementById('student-id').value;
            const studentAnswer = document.getElementById('student-answer').value;

            if (!studentName || !studentAnswer) {
                alert('Please fill in both your name and answer.');
                return;
            }

            // Save to database
            const response = {
                studentName,
                studentId,
                answer: studentAnswer,
                submissionDate: new Date().toLocaleDateString()
            };

            if (ResponseDB.saveResponse(response)) {
                // Generate and download PDF
                await generatePDF(response);
                alert('Response submitted successfully! PDF downloaded.');
                
                // Clear form
                document.getElementById('student-name').value = '';
                document.getElementById('student-id').value = '';
                document.getElementById('student-answer').value = '';
            } else {
                alert('Error saving response. Please try again.');
            }
        }

        // PDF Generation
        async function generatePDF(response) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(20);
            doc.text('The Ripple Effect Lab - Exit Ticket', 20, 30);
            
            // Student info
            doc.setFontSize(12);
            doc.text(`Student Name: ${response.studentName}`, 20, 50);
            if (response.studentId) {
                doc.text(`Student ID: ${response.studentId}`, 20, 60);
            }
            doc.text(`Submission Date: ${response.submissionDate}`, 20, 70);
            
            // Question and answer
            doc.setFontSize(14);
            doc.text('Key Question:', 20, 90);
            doc.setFontSize(10);
            const question = "Select one historical scenario and one modern scenario. Based on what you saw in the lab, what is the single most important repeating pattern or lesson you see about the relationship between solving one problem and creating new, unintended problems for people or the environment?";
            const splitQuestion = doc.splitTextToSize(question, 170);
            doc.text(splitQuestion, 20, 100);
            
            doc.setFontSize(14);
            doc.text('Student Response:', 20, 130);
            doc.setFontSize(11);
            const splitAnswer = doc.splitTextToSize(response.answer, 170);
            doc.text(splitAnswer, 20, 140);
            
            // Footer
            doc.setFontSize(8);
            doc.text('Generated by The Ripple Effect Lab - Understanding Cause and Consequence Through History', 20, 280);
            
            // Download PDF
            doc.save(`RippleEffectLab-${response.studentName}.pdf`);
        }

        // Initialize the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
